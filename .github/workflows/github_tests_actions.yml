name: NukeServerSocket
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  pull_request_target:
    branches:
      - main
jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-12, windows-latest]
        python-version: ["3.7", "3.9", "3.10"]
      fail-fast: false

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Poetry
      run: |
        pip install --upgrade pip
        pip install poetry

    - name: Install dependencies
      run: |
        poetry config virtualenvs.in-project true
        poetry install
        pip install -e .
      
    - name: Debug Information (Post-install)
      run: |
        echo "Python version: $(python --version)"
        echo "Pip version: $(pip --version)"
        echo "Poetry version: $(poetry --version)"
        echo "Installed packages:"
        pip list
        echo "Python path:"
        poetry run python -c "import sys; print(sys.path)"
        echo "Can we import nukeserversocket?"
        poetry run python -c "import nukeserversocket; print('Success!')"
  
    - name: Run tests
      run: |
        pytest -v
        
    - name: Debug on failure
      if: failure()
      run: |
        echo "Test failure occurred. Debugging information:"
        echo "Current directory: $(pwd)"
        echo "Directory contents:"
        ls -R
        echo "Python path:"
        poetry run python -c "import sys; print(sys.path)"
        echo "Content of site-packages:"
        ls $(poetry run python -c "import site; print(site.getsitepackages()[0])")
